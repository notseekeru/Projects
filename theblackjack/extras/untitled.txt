#include <Wire.h>
#include <Adafruit_GFX.h>
#include <Adafruit_SSD1306.h>
#include <cstdlib>
#include <ctime>
#include <string.h>

#define BUTTON_PIN_18 18    // START GAME
#define BUTTON_PIN_5  19    // DECREASE BET (changed from 5)
#define BUTTON_PIN_4  4     // HIT
#define BUTTON_PIN_2  23    // STAND (changed from 2)
#define BUTTON_PIN_15 15    // INCREASE BET

Adafruit_SSD1306 display(128, 64, &Wire, -1);


// FUNCTIONS

void centerText(const char* text, int y) {
  display.setTextSize(1);
  display.setTextColor(SSD1306_WHITE);
  int16_t x1, y1;
  uint16_t w, h;
  display.getTextBounds(text, 0, 0, &x1, &y1, &w, &h); // Calculate text bounds (width and height)
  // Calculate the starting X position for center alignment
  int x = (128 - w) / 2;
  // Set the cursor position
  display.setCursor(x, y);
  // Print the text
  display.println(text);
}

void displayStartMenu() {
    display.clearDisplay();

    centerText("=== START ===",2);
    centerText("PLAY?",25);
    centerText("C = YES | NO = D",50);
    
    display.display();
}

void displayHitOrStandMenu() {
    display.clearDisplay();
    centerText("HIT OR STAND",20);
    centerText("C - HIT | STAND - D",40);
    display.display();
}


// BUTTON LOGIC
int curSt_1, curSt_2, curSt_3, curSt_4, curSt_5;
int lastSt_1, lastSt_2, lastSt_3, lastSt_4, lastSt_5 = LOW;
int result;
unsigned long lastDebounceTime = 0;
const unsigned long debounceDelay = 200;  // 200ms debounce delay

int waitForButton() {

    curSt_1 = digitalRead(BUTTON_PIN_18);
    curSt_2 = digitalRead(BUTTON_PIN_5);
    curSt_3 = digitalRead(BUTTON_PIN_4);
    curSt_4 = digitalRead(BUTTON_PIN_2);
    curSt_5 = digitalRead(BUTTON_PIN_15);

    result = -1;

    if (lastSt_1 == HIGH && curSt_1 == LOW) {
        result = 1;
    }
    else if (lastSt_2 == HIGH && curSt_2 == LOW) {
        result = 2;
    }
    else if (lastSt_3 == HIGH && curSt_3 == LOW) {
        result = 3;
    }
    else if (lastSt_4 == HIGH && curSt_4 == LOW) {
        result = 4;
    }
    else if (lastSt_5 == HIGH && curSt_5 == LOW) {
        result = 5;
    }

    if (result != -1) {
        if ((millis() - lastDebounceTime) > debounceDelay) {
            lastDebounceTime = millis();
        } else {
            result = -1;  // Ignore button press within debounce period
        }
    }

    lastSt_1 = curSt_1;
    lastSt_2 = curSt_2;
    lastSt_3 = curSt_3;
    lastSt_4 = curSt_4;
    lastSt_5 = curSt_5;

    return result;
}

// ACTUAL LOGIC OF THE ESP32
void setup() {
    Serial.begin(115200);

    pinMode(BUTTON_PIN_18, INPUT_PULLUP);
    pinMode(BUTTON_PIN_5, INPUT_PULLUP);
    pinMode(BUTTON_PIN_4, INPUT_PULLUP);
    pinMode(BUTTON_PIN_2, INPUT_PULLUP);
    pinMode(BUTTON_PIN_15, INPUT_PULLUP);
    
    if(!display.begin(SSD1306_SWITCHCAPVCC, 0x3C)) { 
        Serial.println(F("SSD1306 allocation failed"));
    for(;;);
    }

    displayStartMenu();
}

inMenu = false
void loop() {
    while(true) {
        int ans = waitForButton();

        if (ans == 1) {
            Serial.println("BTN 1 - START GAME");
        }
        if (ans == 2) {
            Serial.println("BTN 2 - DECREASE BET");
        }
        if (ans == 3) {
            Serial.println("BTN 3 - HIT");
            displayHitOrStandMenu();
        }
        if (ans == 4) {
            Serial.println("BTN 4 - STAND");
            display.clearDisplay();
            centerText("KYS (IN GAME)", 30);
            display.display();
            while(true) {
                delay(1000);
            }
        }
        if (ans == 5) {
            Serial.println("BTN 5 - INCREASE BET");
        }
    }
}
